services:

  # =======================
  # PostgreSQL
  # =======================
  postgres:
    profiles:
      - core
    image: postgres:${POSTGRES_VERSION:-15}
    container_name: swe-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 123456
    command: [ "postgres", "-c", "wal_level=logical" ]
    volumes:
      - swe-postgres:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          memory: 512M
    networks: [ swe-network ]

  # =======================
  # MongoDB
  # =======================
  mongo:
    profiles:
      - nosql
    image: mongo:${MONGO_VERSION:-6}
    container_name: swe-mongo
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: 123456
    volumes:
      - swe-mongo:/data/db
    deploy:
      resources:
        limits:
          memory: 512M
    networks: [ swe-network ]

  # =======================
  # MinIO
  # =======================
  minio:
    profiles:
      - s3
    image: minio/minio
    container_name: swe-minio
    restart: unless-stopped
    command: server --console-address ":9001" /data
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio123
    volumes:
      - minio-storage:/data
    deploy:
      resources:
        limits:
          memory: 512M
    networks: [ swe-network ]

  # =======================
  # Redis
  # =======================
  redis:
    profiles:
      - core
    image: redis:${REDIS_VERSION:-7}
    container_name: swe-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --maxmemory 128mb --maxmemory-policy allkeys-lru
    deploy:
      resources:
        limits:
          memory: 256M
    networks: [ swe-network ]

  # =======================
  # Zookeeper
  # =======================
  zookeeper:
    profiles:
      - core
    image: debezium/zookeeper:${DEBEZIUM_VERSION:-2.5}
    container_name: swe-zookeeper
    restart: unless-stopped
    ports:
      - "2181:2181"
    environment:
      JVMFLAGS: "-Xms256m -Xmx256m"
      LOG_LEVEL: WARN
    deploy:
      resources:
        limits:
          memory: 512M
    networks: [ swe-network ]

  # =======================
  # Kafka
  # =======================
  kafka:
    profiles:
      - core
    image: debezium/kafka:${DEBEZIUM_VERSION:-2.5}
    container_name: swe-kafka
    restart: unless-stopped
    depends_on: [ zookeeper ]
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      ZOOKEEPER_CONNECT: swe-zookeeper:2181
      KAFKA_HEAP_OPTS: "-Xms512m -Xmx512m"
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG_RETENTION_HOURS: "1"
      KAFKA_LISTENERS: PLAINTEXT://swe-kafka:29092,PLAINTEXT_HOST://swe-kafka:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://swe-kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
    deploy:
      resources:
        limits:
          memory: 1G
    networks: [ swe-network ]

  # =======================
  # Kafka UI (AKHQ)
  # =======================
  kafka-ui:
    profiles:
      - ui
    image: tchiotludo/akhq:0.24.0
    container_name: swe-kafka-ui
    restart: unless-stopped
    ports:
      - "8088:8080"
    environment:
      AKHQ_CONFIGURATION: |
        akhq:
          connections:
            docker:
              properties:
                bootstrap.servers: "swe-kafka:29092"
    depends_on: [ kafka ]
    deploy:
      resources:
        limits:
          memory: 256M
    networks: [ swe-network ]

  # =======================
  # Debezium
  # =======================
  debezium:
    profiles:
      - cdc
    image: debezium/connect:${DEBEZIUM_VERSION:-2.5}
    container_name: swe-debezium
    restart: unless-stopped
    depends_on: [ kafka, postgres ]
    ports:
      - "8083:8083"
    environment:
      BOOTSTRAP_SERVERS: swe-kafka:29092
      GROUP_ID: "1"
      CONFIG_STORAGE_TOPIC: debezium_connect_config
      OFFSET_STORAGE_TOPIC: debezium_connect_offset
      STATUS_STORAGE_TOPIC: debezium_connect_status
      KAFKA_HEAP_OPTS: "-Xms256m -Xmx256m"
    deploy:
      resources:
        limits:
          memory: 512M
    networks: [ swe-network ]

  # =======================
  # Keycloak
  # =======================
  keycloak:
    profiles:
      - auth
    image: quay.io/keycloak/keycloak:${KEYCLOAK_VERSION:-24}
    container_name: swe-keycloak
    command: start-dev
    ports:
      - "8080:8080"
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://swe-postgres:5432/keycloak
      KC_DB_USERNAME: postgres
      KC_DB_PASSWORD: 123456
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      JAVA_OPTS_APPEND: "-Xms256m -Xmx256m"
    depends_on: [ postgres ]
    deploy:
      resources:
        limits:
          memory: 512M
    networks: [ swe-network ]

  # =======================
  # Elasticsearch
  # =======================
  elasticsearch:
    profiles:
      - elk
    image: elasticsearch:${ELASTICSEARCH_VERSION:-8.6.2}
    container_name: temporal-elasticsearch
    environment:
      discovery.type: single-node
      xpack.security.enabled: "false"
      ES_JAVA_OPTS: "-Xms256m -Xmx256m"
    expose:
      - "9200"
    deploy:
      resources:
        limits:
          memory: 512M
    networks: [ swe-network ]

  # =======================
  # Temporal
  # =======================
  temporal:
    profiles:
      - elk
    image: temporalio/auto-setup:${TEMPORAL_VERSION:-1.20.0}
    container_name: temporal
    depends_on: [ postgres, elasticsearch ]
    ports:
      - "7233:7233"
    environment:
      DB: postgresql
      DB_PORT: 5432
      POSTGRES_SEEDS: swe-postgres
      POSTGRES_USER: postgres
      POSTGRES_PWD: 123456
      ENABLE_ES: "true"
      DYNAMIC_CONFIG_FILE_PATH: /etc/temporal/config/dynamicconfig/development-sql.yaml
      ES_SEEDS: elasticsearch
      ES_VERSION: v8
    deploy:
      resources:
        limits:
          memory: 512M
    networks: [ swe-network ]
    volumes:
      - ./temporalconfig:/etc/temporal/config/dynamicconfig

  # =======================
  # Temporal UI
  # =======================
  temporal-ui:
    profiles:
      - elk
    image: temporalio/ui:${TEMPORAL_UI_VERSION:-2.10.3}
    container_name: temporal-ui
    ports:
      - "8081:8080"
    environment:
      TEMPORAL_ADDRESS: temporal:7233
      TEMPORAL_CORS_ORIGINS: http://localhost:3001
    depends_on: [ temporal ]
    deploy:
      resources:
        limits:
          memory: 256M
    networks: [ swe-network ]

volumes:
  swe-postgres:
  swe-mongo:
  minio-storage:

networks:
  swe-network:
    driver: bridge